version: 2
jobs:
  build:
    macos:
      xcode: "9.0"

    steps:
      - run:
          name: Prepare directories
          command: |
            export GOPATH=$HOME/go
            export PATH=$PATH:$HOME/.cargo/bin:$HOME/janusbin
            mkdir -p $GOPATH/src/github.com/ethereumproject

      - checkout:
          path:  ~/go/src/github.com/ethereumproject/go-ethereum

      - run:
          name: Install required software
          command: |
            export GOPATH=$HOME/go
            export PATH=$PATH:$HOME/.cargo/bin:$HOME/janusbin
            brew install go
            go version
            brew install bats
            curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable
            cd $HOME; curl -sL https://raw.githubusercontent.com/ethereumproject/janus/master/get.sh | bash

      - run:
          name: Compile SputnikVM-ffi
          command: |
            export GOPATH=$HOME/go
            export PATH=$PATH:$HOME/.cargo/bin:$HOME/janusbin
            git clone https://github.com/ethereumproject/sputnikvm-ffi $GOPATH/src/github.com/ethereumproject/sputnikvm-ffi
            cd $GOPATH/src/github.com/ethereumproject/sputnikvm-ffi/c/ffi && cargo build --release
            cp $GOPATH/src/github.com/ethereumproject/sputnikvm-ffi/c/ffi/target/release/libsputnikvm_ffi.a $GOPATH/src/github.com/ethereumproject/sputnikvm-ffi/c/libsputnikvm.a

      - run:
          name: Run unit tests
          command: |
            export GOPATH=$HOME/go
            export PATH=$PATH:$HOME/.cargo/bin:$HOME/janusbin
            export CGO_LDFLAGS="$GOPATH/src/github.com/ethereumproject/sputnikvm-ffi/c/libsputnikvm.a -ldl -lresolv";
            cd $GOPATH/src/github.com/ethereumproject/go-ethereum
            go env
            go test -tags=sputnikvm ./...

      - run:
          name: Run bats tests
          command: |
            export GOPATH=$HOME/go
            export PATH=$PATH:$HOME/.cargo/bin:$HOME/janusbin
            export CGO_LDFLAGS="$GOPATH/src/github.com/ethereumproject/sputnikvm-ffi/c/libsputnikvm.a -ldl -lresolv";
            cd $GOPATH/src/github.com/ethereumproject/go-ethereum
            go install -tags=sputnikvm -ldflags "-X main.Version=`janus version -format TAG_OR_NIGHTLY`" ./cmd/geth
            bats cmd/geth

      - deploy:
          name: Deploy to builds.etcdevteam.com
          command: |
            export GOPATH=$HOME/go
            export PATH=$PATH:$HOME/.cargo/bin:$HOME/janusbin
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              ./deploy.sh
            fi

